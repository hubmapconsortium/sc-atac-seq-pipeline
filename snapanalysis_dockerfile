FROM ubuntu:18.04

# Install R, python 2.7, and other requirements
RUN apt-get update
RUN apt-get install -y tzdata # install separately so it doesn't prompt for input
RUN apt-get install -y \
    build-essential \
    cython \
    gzip \
    libcurl4-openssl-dev \
    libgsl-dev \
    libssl-dev \
    libxml2-dev \
    r-recommended=3.4.4-1ubuntu1 \
    pandoc \
    perl \
    python2.7 \
    python-pip \
    texlive-latex-extra \
    unzip \
    wget

RUN pip install 'snaptools==1.4.8'

# Install MACS package that uses Python 2.7 since snapTools requires Python 2.7
# and the default python version will be 2.7
RUN pip install 'MACS2==2.1.4'

# Homer is needed for example 10X_brain_5k Step 15. Motif analysis identifies master regulators
# http://homer.ucsd.edu/homer/introduction/install.html
# TODO: Do we need samtools and DESeq2 and EdgeR as described in the Homer install instructions?
#WORKDIR homer
#RUN wget -O configureHomer.pl http://homer.ucsd.edu/homer/configureHomer.pl && \
#     perl configureHomer.pl -install
#
#RUN chmod -R a+w /homer
#
#VOLUME /homer
#
#ENV PATH="${PATH}:/homer/bin"

# Install R packages
RUN R -e "install.packages(c('devtools', 'Matrix', 'doSNOW', 'plot3D', 'optparse'))"
# Install SnapATAC
RUN R -e "library(devtools); install_github('r3fang/SnapATAC')"
# Install R packages using BioConductor according to Legacy and Older R Versions
# at https://bioconductor.org/install/#install-bioconductor-packages
RUN R -e "source('https://bioconductor.org/biocLite.R')"
# Needed to install chromVAR
#RUN R -e "install.packages('gsl')"
# Needed to install chromVAR
#RUN R -e "BiocInstaller::biocLite(c('DirichletMultinomial'))"
# Needed for motif analysis step
#RUN R -e "BiocInstaller::biocLite(c('chromVAR'))"
#RUN R -e "BiocInstaller::biocLite(c('motifmatchr'))"
#RUN R -e "BiocInstaller::biocLite(c('SummarizedExperiment'))"
#RUN R -e "BiocInstaller::biocLite(c('BSgenome.Mmusculus.UCSC.mm10'))"
#RUN R -e "BiocInstaller::biocLite(c('rGREAT'))"
#RUN R -e "BiocInstaller::biocLite(c('JASPAR2016'))"

# Needed for GREAT to identify biological pathways 
#RUN R -e "library(devtools); install_github('jokergoo/rGREAT')"

RUN R -e "BiocInstaller::biocLite(c('BSgenome.Hsapiens.UCSC.hg38'))"

# Needed for cell selection work around described at
# https://github.com/r3fang/SnapATAC/issues/139
RUN R -e "BiocInstaller::biocLite(c('rtracklayer'))"

#RUN R -e "install.packages('BiocManager')"; 
#RUN R -e "BiocManager::install('GO.db')"
#RUN R -e "BiocManager::install('chromVAR')" 
          
         #library(devtools); \
         #source('https://bioconductor.org/biocLite.R'); \
          #biocLite('GO.db'); \
          #install_github('GreenleafLab/chromVAR')"
# For the write.hclust call
RUN R -e "install.packages('RFLPtools')"

# Used when running an R markdown document
RUN R -e "install.packages('rmarkdown')"

# Needed for R markdown to create PDF files
RUN R -e "install.packages('dplyr')"
#RUN R -e "install.packages('tinytex')"
#RUN R -e "tinytex::install_tinytex()"  # install TinyTeX

COPY ./snapAnalysis.R /tools/
COPY ./snapAnalysis_select_barcode.R /tools/

ENV PATH /tools/:$PATH
